<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta charset="utf-8" />
		<link rel="stylesheet" href="menubox.css"/>
		<link rel="stylesheet" href="tooltip.css"/>
		<link rel="stylesheet" href="views/classic.css"/>
		<link rel="stylesheet" href="views/listview.css"/>
		<script src="lib/array.prototype.js">//</script>
		<script src="lib/string.prototype.js">//</script>
		<script src="lib/dhtml.js">//</script>
	</head>
<body>
		<script src="lib/resources.class.js">//</script>
		<script src="lib/menubox.class.js">//</script>
		<script src="lib/undoer.class.js">//</script>

		<script src="res/profiles-meta.json.js">//</script>
		<script src="res/specialrules-sbh.json.js">//</script>
		<script src="res/specialrules-sgd.json.js">//</script>
		<script src="res/specialrules-sww.json.js">//</script>
		<script src="res/specialrules-sdg.json.js">//</script>
		<script src="res/specialrules-sam.json.js">//</script>

		<script src="settings.class.js">//</script>
		<script src="unit.class.js">//</script>
		<script src="warband.class.js">//</script>
		<script src="rulecheck.js">//</script>
		<script src="warbandcreator.class.js">//</script>
		<script src="views/abstractview.class.js">//</script>
		<script src="views/htmlformsview.class.js">//</script>
		<script src="views/classicview.class.js">//</script>
		<script src="views/listview.class.js">//</script>

		<!-- <script src="sbh-owc.html.js">//</script> -->

		<div id="canvas">canvas</div>
		
		<div id="snapshots" style="display:none; position:absolute; top:0px; right:0px; border:1px solid silver; padding:1em; font-size:small;">.</div>

<script type="text/javascript">

let owc = new WarbandCreator();
//let view = new ClassicView(owc.settings, owc.resources, document.getElementById("canvas"));
let view = new ListView(owc.settings, owc.resources, document.getElementById("canvas"));

window.addEventListener("resize", windowEventListener);
window.addEventListener("scroll", windowEventListener);
window.addEventListener("editor", editorEventListener);
window.addEventListener("menubox", windowEventListener);

function snapshots()
{
	let n = document.getElementById("snapshots");
	dhtml.clearNode(n);
	for (let s = 0; s < owc.undoer.snapshots.length; s += 1)
	{
		n.appendChild(dhtml.createNode("p", "", {}, owc.undoer.snapshots[s].description));
	}
};

function printUnit(unitIndex)
{
	view.printUnit(owc.warband.units[unitIndex], unitIndex);
	view.printWarbandSummary(owc.warband);
};

function printWarband()
{
	view.printWarband(owc.warband);
};
	
function editorEventListener(editorEvent)
{
	console.log("editorEvent", editorEvent.detail);
	let unitIndex = Number(editorEvent.detail.unitindex);
	switch (editorEvent.detail.editor)
	{
	case "warbandname":
		owc.setWarbandName(editorEvent.detail.value);
		view.printWarbandName(owc.warband);
		break;
	case "name":
		owc.setUnitName(unitIndex, editorEvent.detail.value);
		printUnit(unitIndex);
		break;
	case "count":
		owc.setUnitCount(unitIndex, Number(editorEvent.detail.value));
		printUnit(unitIndex);
		break;
	case "quality":
		owc.setUnitQuality(unitIndex, editorEvent.detail.value);
		printUnit(unitIndex);
		break;
	case "combat":
		owc.setUnitCombatscore(unitIndex, editorEvent.detail.value);
		printUnit(unitIndex);
		break;
	case "specialruletext":
		owc.setSpecialruleText(unitIndex, editorEvent.detail.specialruleindex, editorEvent.detail.value);
		printUnit(unitIndex);
		break;
	}
	switch (editorEvent.detail.action)
	{
	case "addunit":
		owc.addUnit();
		printWarband();
		break;
	case "addspecialrule":
		owc.addSpecialrule(unitIndex, editorEvent.detail.value);
		printUnit(unitIndex);
		editorEvent.detail.originalEvent.target.value = "";
		break;
	case "removespecialrule":
		owc.removeSpecialrule(unitIndex, editorEvent.detail.value);
		printUnit(unitIndex);
		break;
	case "showunitmenu":
		view.unitMenu.popup(editorEvent.detail.originalEvent, unitIndex);
		break;
	case "duplicate":
		owc.duplicateUnit(unitIndex, editorEvent.detail.value);
		printWarband();
		break;
	case "copy":
		console.warn("unhandled editorevent \"copy\"");
		break;
	case "remove":
		owc.removeUnit(unitIndex, editorEvent.detail.value);
		printWarband();
		break;
	case "moveup":
		owc.moveUnitUp(unitIndex, editorEvent.detail.value);
		printWarband();
		break;
	case "movedown":
		owc.moveUnitDown(unitIndex, editorEvent.detail.value);
		printWarband();
		break;
	}
	snapshots();
};

function windowEventListener(windowEvent)
{
	/*
	if (windowEvent.type === "scroll")
	{
		let topMenuWrapper = document.getElementById("top_menu_wrapper");
		let topMenuNode = document.getElementById("top_menu");
		if (window.pageYOffset > topMenuWrapper.offsetTop)
		{
			topMenuNode.classList.add("stay-at-top");
			topMenuWrapper.style.height = topMenuNode.clientHeight + "px";
		}
		else
		{
			topMenuNode.classList.remove("stay-at-top");
			topMenuWrapper.style.height = "auto";
		};
	};
	*/
	let eventHandlerName = "onWindow" + windowEvent.type.substr(0, 1).toUpperCase() + windowEvent.type.substr(1).toLowerCase();
	console.log(eventHandlerName);
	if (view[eventHandlerName] !== undefined)
	{
		view[eventHandlerName](windowEvent);
	};
};

owc.addSpecialrule(0, "ld");
owc.addSpecialrule(0, "ht");
//owc.warband.name = "Unnamed #1";
view.printWarband(owc.warband);

snapshots();

//owc.settings.language = "de"
//view.applySettings(owc.settings)
//console.log(view._specialrules);
/*
*/

</script>
</body>
</html>
